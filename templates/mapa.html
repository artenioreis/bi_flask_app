<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa Estrat√©gico - Varej√£o Farma</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .filter-bar { background: white; padding: 15px 30px; display: flex; gap: 20px; align-items: flex-end; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #map { flex: 1; z-index: 1; }
        .btn { background: #667eea; color: white; padding: 8px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1>üìç Mapa de Vendas</h1>
        <a href="/dashboard" style="color: white; text-decoration: none; font-size: 13px;">‚Üê Voltar ao BI</a>
    </header>

    <form class="filter-bar" method="GET" action="/mapa">
        <input type="date" name="inicio" value="{{ data_inicio }}">
        <input type="date" name="fim" value="{{ data_fim }}">
        <select name="vendedor" required>
            <option value="">-- Selecione o Vendedor --</option>
            {% for v in vendedores %}
            <option value="{{ v[0] }}" {% if vendedor_selecionado|string == v[0]|string %}selected{% endif %}>{{ v[1] }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn">FILTRAR E LOCALIZAR</button>
    </form>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([-23.5505, -46.6333], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const pontos = {{ pontos|tojson }};
        
        if (pontos.length > 0) {
            var bounds = L.latLngBounds();
            pontos.forEach(p => {
                const coord = [p.lat, p.lon];
                L.marker(coord).addTo(map).bindPopup(p.label + "<br><small>" + p.end + "</small>");
                bounds.extend(coord);
            });
            map.fitBounds(bounds, { padding: [50, 50] });
        } else if ("{{ vendedor_selecionado }}" !== "") {
            alert("Nenhuma venda encontrada para este vendedor.");
        }
    </script>
</body>
</html>