<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Análise Cliente: {{ cliente[1] }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; }
        .navbar { background: linear-gradient(135deg, #667eea, #764ba2); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .navbar-brand { font-size: 20px; font-weight: bold; text-decoration: none; color: white; }
        .v-tag { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .btn-back { background-color: rgba(255,255,255,0.1); color: white; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: 600; border: 1px solid rgba(255,255,255,0.2); }
        .main-container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .card-header-client { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #667eea; }
        .finance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .finance-item { background: #f8f9fa; padding: 15px; border-radius: 12px; text-align: center; border-left: 4px solid #667eea; }
        .chart-container { height: 300px; position: relative; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f0f2f5; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="navbar-brand">BI Varejão Farma <span class="v-tag">v43.4 Blindada</span></a>
        <div>
            <a href="/dashboard" class="btn-back">← Voltar</a>
            <a href="/logout" style="color: white; margin-left: 15px; text-decoration: none;">Sair</a>
        </div>
    </nav>

    <div class="main-container">
        <div class="card card-header-client">
            <div><h1>{{ cliente[1] }}</h1><small>Código: {{ cliente[0] }}</small></div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #7f8c8d;">SITUAÇÃO</div>
                <div style="font-size: 22px; font-weight: 800; color: {% if dias_atraso > 0 %}#e74c3c{% else %}#2ecc71{% endif %};">
                    {% if dias_atraso > 0 %}EM ATRASO ({{ dias_atraso }}d){% else %}REGULAR{% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px;">Resumo Financeiro</h3>
            <div class="finance-grid">
                <div class="finance-item"><div>Limite</div><strong>R$ {{ "%.2f"|format(limite_credito) }}</strong></div>
                <div class="finance-item" style="border-color: #2ecc71;"><div>Venda Real</div><strong>R$ {{ "%.2f"|format(vendas_atual) }}</strong></div>
                <div class="finance-item" style="border-color: #f1c40f;"><div>Meta (Excel)</div><strong>R$ {{ "%.2f"|format(objetivo) }}</strong></div>
                <div class="finance-item" style="border-color: {% if dias_atraso > 0 %}#e74c3c{% else %}#2ecc71{% endif %};"><div>Atraso</div><strong>{{ dias_atraso }} dias</strong></div>
            </div>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="margin-bottom: 15px;">Atingimento de Meta</h3>
            <div style="height: 150px;"><canvas id="metaGauge"></canvas></div>
            <div id="percVal" style="font-size: 24px; font-weight: 800; margin-top: -30px;">0%</div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h3 style="margin-bottom: 15px;">Evolução Mensal (Comparativo Anual)</h3>
            <div class="chart-container"><canvas id="compChart"></canvas></div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h3 style="margin-bottom: 15px;">Títulos em Aberto</h3>
            <table>
                <thead><tr><th>Documento</th><th>Emissão</th><th>Vencimento</th><th>Valor</th><th>Saldo</th></tr></thead>
                <tbody>
                    {% for t in titulos %}
                    <tr><td>{{ t[0] }}</td><td>{{ t[4].strftime('%d/%m/%Y') }}</td><td>{{ t[5].strftime('%d/%m/%Y') }}</td><td>R$ {{ "%.2f"|format(t[2]) }}</td><td>R$ {{ "%.2f"|format(t[3]) }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // GAUGE
        const perc = {{ objetivo }} > 0 ? ({{ vendas_atual }} / {{ objetivo }} * 100) : 0;
        document.getElementById('percVal').textContent = perc.toFixed(1) + '%';
        new Chart(document.getElementById('metaGauge'), { type: 'doughnut', data: { datasets: [{ data: [Math.min(perc, 100), Math.max(0, 100 - perc)], backgroundColor: ['#2ecc71', '#eee'], circumference: 180, rotation: 270, cutout: '80%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });

        // GRÁFICO DE BARRAS
        const hist = {{ comparativo | tojson }};
        const d24 = Array(12).fill(0), d25 = Array(12).fill(0), d26 = Array(12).fill(0);
        hist.forEach(h => { if(h.ano===2024) d24[h.mes-1]=h.total; else if(h.ano===2025) d25[h.mes-1]=h.total; else if(h.ano===2026) d26[h.mes-1]=h.total; });

        new Chart(document.getElementById('compChart'), {
            type: 'bar',
            data: {
                labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                datasets: [
                    { label: '2024', data: d24, backgroundColor: '#e74c3c' },
                    { label: '2025', data: d25, backgroundColor: '#f1c40f' },
                    { label: '2026', data: d26, backgroundColor: '#2ecc71' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    </script>
</body>
</html>