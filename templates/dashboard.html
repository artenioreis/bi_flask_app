<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>BI Varej√£o - Dashboard v45.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS BLINDADO v44.9 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; line-height: 1.5; }
        header { background: #fff; padding: 12px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 800; color: #333; font-size: 18px; }
        .v-tag { background: #667eea; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 10px; }
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        .toolbar { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: flex-end; margin-bottom: 25px; border: 1px solid #eee; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-label { font-size: 10px; font-weight: 800; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input { padding: 9px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; background: #fff; min-width: 180px; }
        .btn { padding: 10px 22px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; border: none; color: white; text-transform: uppercase; text-decoration: none; display: flex; align-items: center; justify-content: center; }
        .btn-blue { background: #5c6bc0; }
        .btn-green { background: #2ecc71; }
        .btn-purple { background: #764ba2; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid #eee; }
        .title-card { color: #5c6bc0; font-size: 11px; font-weight: 800; text-align: center; margin-bottom: 20px; border-bottom: 1px solid #f8f9fa; padding-bottom: 10px; text-transform: uppercase; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .performance-layout { display: grid; grid-template-columns: 1fr 340px; gap: 20px; margin-bottom: 20px; }
        .stat-main { font-size: 26px; font-weight: 800; color: #333; text-align: center; display: block; }
        .metrics-container { display: flex; justify-content: space-around; align-items: center; padding: 15px 0; }
        .metric-item { text-align: center; }
        .metric-label { font-size: 12px; color: #888; margin-bottom: 6px; font-weight: 600; }
        .metric-value { font-size: 20px; font-weight: 800; color: #333; }
        .top-purple { border-top: 4px solid #6f42c1; }
        .top-green { border-top: 4px solid #28a745; }
        .top-orange { border-top: 4px solid #fd7e14; }
        .side-blue { border-left: 5px solid #007bff; }
        .side-pink { border-left: 5px solid #e83e8c; }
        .side-red { border-left: 5px solid #dc3545; }
        .gauge-box { height: 120px; position: relative; }
        .gauge-text { font-size: 24px; font-weight: 800; text-align: center; margin-top: -35px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { padding: 15px; background: #f8f9fa; color: #5c6bc0; text-align: left; font-weight: 800; text-transform: uppercase; font-size: 11px; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>
    <header>
        <div class="logo">BI VAREJ√ÉO FARMA <span class="v-tag">V45.0</span></div>
        <div style="font-size: 13px;">{{ session.user }} | <a href="/logout" style="color:#dc3545; font-weight: bold; text-decoration: none;">Sair</a></div>
    </header>

    <div class="container">
        <div class="toolbar">
            <div class="filter-group">
                <span class="filter-label">TIPO</span>
                <select id="tipo" onchange="toggle()">
                    <option value="todos" {% if filtro_ativo == 'todos' %}selected{% endif %}>Geral</option>
                    <option value="vendedor" {% if filtro_ativo == 'vendedor' %}selected{% endif %}>Vendedor</option>
                    <option value="cliente" {% if filtro_ativo == 'cliente' %}selected{% endif %}>Cliente</option>
                </select>
            </div>
            <div class="filter-group" id="vInput" style="display:{% if filtro_ativo == 'vendedor' %}flex{% else %}none{% endif %};">
                <span class="filter-label">VENDEDOR</span>
                <select id="vSel">{% for v in vendedores %}<option value="{{ v[0] }}" {% if valor_filtro|string == v[0]|string %}selected{% endif %}>{{ v[1] }}</option>{% endfor %}</select>
            </div>
            <div id="cInput" class="filter-group" style="display:{% if filtro_ativo == 'cliente' %}flex{% else %}none{% endif %};">
                <span class="filter-label">CLIENTE</span>
                <input type="text" id="cSearch" value="{{ valor_filtro }}" placeholder="C√≥d ou Nome...">
            </div>
            <button class="btn btn-blue" onclick="apply()">Filtrar</button>
            <a href="/mapa" class="btn btn-green">üìç Regional</a>
            <a href="/usuarios" class="btn btn-purple">üë• Usu√°rios</a>
        </div>

        {% if filtro_ativo == 'vendedor' %}
        <div class="grid-3">
            <div class="card top-purple"><div class="title-card">TOTAL CARTEIRA</div><span class="stat-main">{{ vendedor_stats.total_carteira }}</span></div>
            <div class="card top-green"><div class="title-card">CLIENTES ATENDIDOS</div><span class="stat-main">{{ vendedor_stats.atendidos }}</span></div>
            <div class="card top-orange"><div class="title-card">POSITIVA√á√ÉO</div><span class="stat-main">{{ "%.1f"|format((vendedor_stats.atendidos/vendedor_stats.total_carteira)*100) if vendedor_stats.total_carteira > 0 else 0 }}%</span></div>
        </div>

        <div class="performance-layout">
            <div class="card" style="border-top: 4px solid #6f42c1;">
                <div class="title-card">PERFORMANCE VENDEDOR</div>
                <div class="metrics-container">
                    <div class="metric-item"><div class="metric-label">Meta</div><div class="metric-value">R$ {{"%.2f"|format(sel.meta)}}</div></div>
                    <div class="metric-item"><div class="metric-label">Realizado</div><div class="metric-value" style="color:#007bff;">R$ {{"%.2f"|format(sel.realizado)}}</div></div>
                    <div class="metric-item"><div class="metric-label">Proj.</div><div class="metric-value" style="color:#6f42c1;">R$ {{"%.2f"|format(sel.valor_projecao)}}</div></div>
                </div>
            </div>
            <div class="card" style="border-top: 4px solid #6f42c1; text-align: center;">
                <div class="title-card">VELOCIDADE VENDEDOR</div>
                <div class="gauge-box"><canvas id="gSel"></canvas></div>
                <div class="gauge-text" style="color:#6f42c1;">{{ "%.1f"|format(sel.atingimento_proj) }}%</div>
            </div>
        </div>
        {% else %}
        <div class="performance-layout">
            <div class="card">
                <div class="title-card">PERFORMANCE EMPRESA</div>
                <div class="metrics-container">
                    <div class="metric-item"><div class="metric-label">Meta</div><div class="metric-value">R$ {{"%.2f"|format(proj.meta)}}</div></div>
                    <div class="metric-item"><div class="metric-label">Realizado</div><div class="metric-value" style="color:#007bff;">R$ {{"%.2f"|format(proj.realizado)}}</div></div>
                    <div class="metric-item"><div class="metric-label">Proj.</div><div class="metric-value" style="color:#5c6bc0;">R$ {{"%.2f"|format(proj.valor_projecao)}}</div></div>
                </div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="title-card">VELOCIDADE EMPRESA</div>
                <div class="gauge-box"><canvas id="gEmp"></canvas></div>
                <div class="gauge-text" style="color:#5c6bc0;">{{ "%.1f"|format(proj.atingimento_proj) }}%</div>
            </div>
        </div>
        {% endif %}

        <div class="performance-layout">
            <div class="card">
                <div class="title-card">METAS CLIENTES (EXCEL)</div>
                <div class="metrics-container">
                    <div class="metric-item"><div class="metric-label">Meta Base</div><div class="metric-value">R$ {{"%.2f"|format(clie_proj.meta)}}</div></div>
                    <div class="metric-item"><div class="metric-label">Venda Real</div><div class="metric-value" style="color:#007bff;">R$ {{"%.2f"|format(clie_proj.realizado)}}</div></div>
                    <div class="metric-item"><div class="metric-label">Proj.</div><div class="metric-value" style="color:#2ecc71;">R$ {{"%.2f"|format(clie_proj.valor_projecao)}}</div></div>
                </div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="title-card">VELOCIDADE CARTEIRA</div>
                <div class="gauge-box"><canvas id="gCli"></canvas></div>
                <div class="gauge-text" style="color:#2ecc71;">{{ "%.1f"|format(clie_proj.atingimento_proj) }}%</div>
            </div>
        </div>

        <div class="grid-3">
            <div class="card side-blue"><div class="title-card" style="text-align:left;">TOTAL LIMITE</div><span class="stat-main" style="text-align:left; padding-left: 10px;">R$ {{"%.2f"|format(geral_clie.limite)}}</span></div>
            <div class="card side-pink"><div class="title-card" style="text-align:left;">TOTAL D√âBITO</div><span class="stat-main" style="text-align:left; padding-left: 10px;">R$ {{"%.2f"|format(geral_clie.debito)}}</span></div>
            <div class="card side-red"><div class="title-card" style="text-align:left;">CLIENTES EM ATRASO</div><span class="stat-main" style="text-align:left; padding-left: 10px;">{{geral_clie.atraso}}</span></div>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <table>
                <thead><tr><th>C√≥d</th><th>Cliente</th><th>Venda Real</th><th>Atraso</th><th style="text-align:center;">A√ß√£o</th></tr></thead>
                <tbody>{% for c in clientes %}<tr><td>{{c[0]}}</td><td style="font-weight:700;">{{c[1]}}</td><td style="font-weight:700;">R$ {{"%.2f"|format(c[10])}}</td><td>{% if c[6]>0 %}<span style="color:#dc3545; font-weight:800;">‚ö†Ô∏è {{c[6]}}d</span>{% else %}<span style="color:#2ecc71; font-weight:800;">‚úì OK</span>{% endif %}</td><td style="text-align:center;"><a href="/analise/{{c[0]}}" style="color:#5c6bc0; font-weight:800; text-decoration:none; background: #f0f2ff; padding: 6px 12px; border-radius: 4px;">VER</a></td></tr>{% endfor %}</tbody>
            </table>
        </div>
    </div>

    <script>
        function toggle(){ const t = document.getElementById('tipo').value; document.getElementById('vInput').style.display = t === 'vendedor' ? 'flex' : 'none'; document.getElementById('cInput').style.display = t === 'cliente' ? 'flex' : 'none'; }
        function apply(){ const t = document.getElementById('tipo').value; let v = t === 'vendedor' ? document.getElementById('vSel').value : document.getElementById('cSearch').value; window.location.href=`/dashboard?tipo=${t}&valor=${v}`; }
        function drawG(id, val, color){ 
            if(!document.getElementById(id)) return;
            new Chart(document.getElementById(id), { type: 'doughnut', data: { datasets: [{ data: [Math.min(val, 100), Math.max(0, 100-val)], backgroundColor: [color, '#f0f0f0'], circumference: 180, rotation: 270, cutout: '80%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } }); 
        }
        drawG('gEmp', {{ proj.atingimento_proj }}, '#5c6bc0');
        drawG('gCli', {{ clie_proj.atingimento_proj }}, '#2ecc71');
        {% if filtro_ativo == 'vendedor' %} drawG('gSel', {{ sel.atingimento_proj }}, '#6f42c1'); {% endif %}
    </script>
</body>
</html>